<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body> 

<input type="radio" name="radio" id="radio1" class="radio"/>
<label for="radio1">Third Option</label>
<input type="radio" name="radio" id="radio2" class="radio"/>
<label for="radio2">Third Option</label>

<canvas id="player" width="500" height="100"></canvas>
<canvas id="demoCanvas" width="500" height="500"></canvas>
</body>
<script src="js/createjs-2015.11.26.min.js"></script>
<script src="js/tweenjs-0.6.2.min.js"></script>
<script>
	var board = {
  'stage': null,
  'stage1': null,
  'end': false,
  'play': [],
  'delay':200,
  'x': {
    color: 'Red'
  },
  'o': {
    color: 'Yellow'
  },
  'square': {
    size: 100,
    color: "DeepSkyBlue"
  },
  'winners': [
    // rows
    {
      a: 1,
      b: 2,
      c: 3
    }, {
      a: 4,
      b: 5,
      c: 6
    }, {
      a: 7,
      b: 8,
      c: 9
    },

    // columns
    {
      a: 1,
      b: 4,
      c: 7
    }, {
      a: 2,
      b: 5,
      c: 8
    }, {
      a: 3,
      b: 6,
      c: 9
    },

    // diagonals
    {
      a: 1,
      b: 5,
      c: 9
    }, {
      a: 3,
      b: 5,
      c: 7
    }
  ],
  "winner":""
};

function notPlayer(player) {
  return player !== 'x' ? 'o' : 'x';
}

function handlePress(id, event) {
	// conDisp(board);
	if (!board.end && board.selectedPlayer && !board[id].player) {
		drawPlayer(board.stage, board[id].x, board[id].y, board.selectedPlayer);
		board[id].player = board.selectedPlayer;
		checkEndCondition();
		botTurn(board.selectedPlayer === 'x' ? 'o' : 'x');
	}
}

function drawPlaySurface(stage, x, y, id) {
  var square = new createjs.Shape();
  square.graphics.beginFill(board.square.color).drawRect(0, 0, board.square.size, board.square.size);
  square.x = 50;
  square.y = 50;
  stage.addChild(square)
  createjs.Tween.get(square, {
      loop: false
    })
    .to({
      x: x,
      y: y
    }, 100, createjs.Ease.getPowInOut(4))
    .to({
      alpha: 1
    }, 50, createjs.Ease.getPowInOut(2))

  board[id] = {
    x: x + board.square.size / 2,
    y: y + board.square.size / 2,
    player: null
  };

  square.addEventListener("mousedown", handlePress.bind(null, id));
}

function drawWinner(win, player) {
  console.log('draw winner');
  var winLine = new createjs.Shape();
  winLine.graphics.setStrokeStyle(3);
  winLine.graphics.beginStroke(board[player].color);
  winLine.graphics.moveTo(board[win.a].x, board[win.a].y);
  winLine.graphics.lineTo(board[win.c].x, board[win.c].y);
  winLine.graphics.endStroke();
  board.play.push(winLine);
  board.stage.addChild(winLine);
}

function checkEndCondition() {
  if (board.end) return true;
  for (var i = 0; i < board.winners.length; i++) {
    var win = board.winners[i];
    console.log('' + board[win.a].player + board[win.b].player + board[win.c].player);
    if (!!board[win.a].player && board[win.a].player === board[win.b].player && board[win.b].player === board[win.c].player) {
      console.log('Win: ' + JSON.stringify(win));
      drawWinner(win, board[win.a].player);
      board.end = true;
      board.winner = board[win.a].player;
    }
  }
  return board.end;
}

function count(pos, counts) {
  if(board[pos].player === null) {
    return;
  }
  
  counts[board[pos].player]++;
  counts.total++;
}

function score(play, player) {
  var counts = { x: 0, o: 0, total: 0 };
  count(play.a, counts);
  count(play.b, counts);
  count(play.c, counts);
  
  if(counts.total === 3) {
    return -1;
  }
  if(counts[notPlayer(player)] == 2) {
    return 7;
  }
  if(counts[player] == 2) {
    return 6;
  }
  if(counts[player] == 1) {
    return 5;
  }
  if(counts[notPlayer(player)] == 1) {
    return 4;
  }
  if(counts.total === 0) {
    return 3;
  }
  if(counts.x + counts.o === 2) {
    return 2;
  }  
  return 0;
}

function selectNextPos(player) {
  var winners = board.winners.slice();
  var win = winners.sort(function(a, b) {
    return score(b, player) > score(a, player);
  });
  var top = win[0];
  if (!board[top.b].player) return top.b;
  if (!board[top.a].player) return top.a;
  if (!board[top.c].player) return top.c;
  throw 'not supposed to happen';
}

function botTurn(player) {
	// setTimeout(function() {
		var pos = selectNextPos(player);
	  board[pos].player = player;
	  drawPlayer(board.stage, board[pos].x, board[pos].y, player);
	  checkEndCondition();
	// }, board.delay);
	  
}

function selectPlayer(player, event) {
  reset();
  board.selectedPlayer = player;
  console.log('Selected player: ' + player);
  if (player !== 'x') {
    botTurn('x');
  }
}

function addSelector(playerShape, player) {
  playerShape.addEventListener("mousedown", selectPlayer.bind(null, player));
}

function conDisp(board, swt) {
	var boardStatus = [];
	for(var i=1; i<=9; i++)	 {
		boardStatus.push(board[i].player?board[i].player:'-');
	}
	if(!swt)
		console.log(boardStatus);
	return boardStatus;
}


function drawPlayer(stage, x, y, player) {
	// setTimeout(function() {
		console.log('drawing ' + player);
	  var o = new createjs.Shape();	
	  o.graphics.beginFill(board[player].color).drawCircle(x, y, 50);
	  stage.addChild(o);
	  board.play.push(o);
	  return o;
	// }, board.delay)
	  
}

function reset() {
  for (var i = 1; i <= 9; i++) {
    board[i].player = null;
  }
  board.play.forEach(function(e) {
    board.stage.removeChild(e);
  });
  board.end = false;
  board.winner = "";
}

function drawBoard(stage) {
  var multiplierWithMargin = board.square.size * 1.1;

  for (var i = 1; i <= 3; i++) {
    for (var j = 1; j <= 3; j++) {
      drawPlaySurface(stage, multiplierWithMargin * j, multiplierWithMargin * i, (i - 1) * 3 + j);
    }
  }
}

function init() {
  board.stage1 = new createjs.Stage("player");
  addSelector(drawPlayer(board.stage1, 225, 50, 'x'), 'x');
  addSelector(drawPlayer(board.stage1, 325, 50, 'o'), 'o');

  board.stage1.update();

  board.stage = new createjs.Stage("demoCanvas");
  drawBoard(board.stage);
  createjs.Ticker.setFPS(60);
  createjs.Ticker.addEventListener("tick", board.stage);
}

// 'x' or 'o'
function chooseRole(v) {
	if('x' === v)
		board.stage1.children[0].dispatchEvent('mousedown');
	else if('o' === v)
		board.stage1.children[1].dispatchEvent('mousedown');
	else
		console.log("choose wrong role");
}

// move 
// i from 1~9
function move(i) {
	// setTimeout(function(){
		var rtn = [];
		if(checkMove(i))
		{
			checkMove(i);
			// setTimeout(function(){
				board.stage.children[i-1].dispatchEvent('mousedown');
			// }, board.delay);
			rtn = conDisp(board, true);
		} else {
			rtn = false;
		}
		return rtn;
	// },board.delay);
	
}

function checkMove(i) {
	var flag = true;
	if(!(i>=0 && i <=9))
	{
		flag = false;
		console.log('move out of 1~9!');
	}
	if(board[i].player)
	{
		flag = false
		console.log('move to occupied space!');
	}
	return flag;
}

function getWinner() {
	if(board.end)
		return board.winner;
	else 
		return false;
}

window.onload = function() {
	init();

	// chooseRole('x');
	// console.log(move(2));console.log(move(3));
}
</script>
</html>